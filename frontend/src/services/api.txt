import axios from 'axios'

// Create axios instance
const apiClient = axios.create({
  baseURL: process.env.VUE_APP_API_BASE_URL || 'http://localhost:8080/api',
  headers: {
    'Content-Type': 'application/json',
    // Add bypass header for localtunnel (removed User-Agent as it's unsafe)
    'bypass-tunnel-reminder': 'true'
  }
})

// Add request interceptor for auth token and localtunnel bypass
apiClient.interceptors.request.use(
  config => {
    const token = localStorage.getItem('token')
    if (token) {
      config.headers['Authorization'] = `Bearer ${token}`
    }
    
    // Ensure bypass header is always present (removed User-Agent)
    config.headers['bypass-tunnel-reminder'] = 'true'
    
    return config
  },
  error => {
    return Promise.reject(error)
  }
)

// Add response interceptor for error handling
apiClient.interceptors.response.use(
  response => {
    return response
  },
  error => {
    // Handle session expiration
    if (error.response && error.response.status === 401) {
      localStorage.removeItem('token')
      window.location.href = '/login'
    }
    
    // Handle localtunnel 511 error
    if (error.response && error.response.status === 511) {
      console.warn('Localtunnel authentication required. Retrying with bypass headers...')
      // The request will be retried automatically with bypass headers
    }
    
    // Extract error message
    const message = error.response?.data?.message || error.message || 'An error occurred'
    error.message = message
    
    return Promise.reject(error)
  }
)

export default {
  // Generic HTTP methods
  get: (url, config) => apiClient.get(url, config),
  post: (url, data, config) => apiClient.post(url, data, config),
  put: (url, data, config) => apiClient.put(url, data, config),
  delete: (url, config) => apiClient.delete(url, config),
  
  // Auth endpoints
  auth: {
    login: () => `${process.env.VUE_APP_API_BASE_URL || 'http://localhost:8080/api'}/auth/facebook`,
    callback: () => '/auth/facebook/callback',
    logout: () => apiClient.post('/auth/logout'),
    getUser: () => apiClient.get('/auth/user')
  },
  
  // Campaign endpoints
  campaigns: {
    getAll: (page = 0, size = 5) => apiClient.get(`/campaigns?page=${page}&size=${size}`),
    get: (id) => apiClient.get(`/campaigns/${id}`),
    create: (campaign) => apiClient.post('/campaigns', campaign),
    update: (id, campaign) => apiClient.put(`/campaigns/${id}`, campaign),
    delete: (id) => apiClient.delete(`/campaigns/${id}`)
  },
  
  // Ad endpoints
  ads: {
    getAll: (page = 0, size = 5) => apiClient.get(`/ads?page=${page}&size=${size}`),
    get: (adId) => apiClient.get(`/ads/${adId}`),
    generate: (generationData) => apiClient.post('/ads/generate', generationData),
    create: (adData) => apiClient.post('/ads', adData),
    selectContent: (adId, contentId) => 
      apiClient.post(`/ads/${adId}/select-content`, null, {
        params: { contentId }
      }),
    getContents: (adId) => apiClient.get(`/ads/${adId}/contents`),
    delete: (adId) => apiClient.delete(`/ads/${adId}`)
  },
  
  // Provider endpoints
  providers: {
    getImageProviders: () => apiClient.get('/ai-providers/image'),
    getTextProviders: () => apiClient.get('/ai-providers/text'),
    getAllProviders: () => apiClient.get('/ai-providers')
  },
  
  // Upload endpoints
  upload: {
    media: (formData) => apiClient.post('/upload/media', formData, {
      headers: {
        'Content-Type': 'multipart/form-data'
      }
    })
  },
  
  // Dashboard
  dashboard: {
    getData: () => apiClient.get('/dashboard')
  },
  
  // Image upload (merged with upload above)
  imageUpload: {
    image: (file, onUploadProgress) => {
      const formData = new FormData()
      formData.append('file', file)
      
      return apiClient.post('/upload/image', formData, {
        headers: {
          'Content-Type': 'multipart/form-data',
          'bypass-tunnel-reminder': 'true'
          // Removed User-Agent header as it's unsafe
        },
        onUploadProgress
      })
    }
  }
}

